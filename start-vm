#!/bin/bash
set -e

if [ ! -f ansible_key.pub ]; then
    echo "No ansible key found"
    ssh-keygen -f ansible_key -N ""
fi

# build single docker image before vagrant starts
if [ $(docker-compose ps -q | wc -l) -eq 0 ]; then
    echo "No images found"
    echo "Building docker images"
    time docker-compose build --force-rm --parallel
fi

# bring up the VMs if they're not running
echo "Bringing docker containers up"
time docker-compose up -d

echo "Starting ansible"
time \
ansible-playbook provision.yml \
    -i ./environments/vm/inventory \
    --extra-vars="secrets_file=environments/vm/secrets/all.yml" \
    $@

# restart proxy to reload all metadata (chicken finds eggs)
ansible -i ./environments/vm/inventory -m command -a 'systemctl restart pyff' proxy >> /dev/null 2>&1

exit 0
