---
- name: Ensure that packages are installed
  apt:
    name:
      - xalan
      - wget
      - xmlsec1
    state: present

- name: Remove obsolete cron file
  file:
    path: /etc/cron.d/create_metadata
    state: absent

- name: Create project directory
  file: path="{{ metadata_project_dir }}" state=directory mode=0755

- name: Create html directory
  file: path="{{ metadata_documentroot }}" state=directory mode=0755

- name: Copy metadata nginx configuration
  template:
    src: metadata.nginx.j2
    dest: "/etc/nginx/sites-available/metadata"
    mode: 0755
  notify: restart nginx

- name: Create symlink to metadata in /etc/nginx/sites-enabled
  file:
    src: "/etc/nginx/sites-available/metadata"
    dest: "/etc/nginx/sites-enabled/00-metadata"
    state: link
  notify: restart nginx

- name: Copy xsl files in place
  copy:
    src: "{{ item }}"
    dest: "{{ metadata_project_dir }}/{{ item }}"
  with_items: "{{xsl_files}}"

- name: Copy eduGAIN public metadata signing cert
  copy:
    content: "{{ edugain_cert }}"
    dest: "{{ metadata_project_dir }}/edugain.crt"
  notify: run metadata cronjob

- name: Copy xsl processing script script in place
  template:
    src: create_metadata.j2
    dest: "{{ metadata_project_dir }}/create_metadata"
    mode: 0755

- name: Install index page
  template:
    src: "index.html.j2"
    dest: "{{metadata_documentroot}}/index.html"
    mode: 0644

- name: Install link to idp feed
  file:
    dest: "{{metadata_documentroot}}/idps.xml"
    src: "{{metadata_idps_targetfile}}"
    state: "link"
