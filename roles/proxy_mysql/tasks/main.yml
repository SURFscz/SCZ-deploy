---
- name: listen mysql on 0.0.0.0
   src="99-myserver.cnf"
    dest="/etc/mysql/mariadb.conf.d/99-myserver.cnf"
    mode=0644
  notify:
    - Restart MySQL

- name: Copy script files
  copy:
    src: "{{ item }}"
    dest: /tmp
  with_items:
    - "create_db.sql"
    - "fkeys.sql"
    - "views.sql"
    - "copersoncol.sql"

- name: create database for {{ comanage_proxy_db_name }}
  mysql_db:
    name: "{{ comanage_proxy_db_name }}"
    state: present

- name: create database for CoManage-Proxy linkup
  mysql_db:
    name: "{{ comanage_proxy_db_name }}"
    state: present

- name: initialize database for CoManage-Proxy linkup
  command: >
    mysql --batch --silent --raw --database "{{ comanage_proxy_db_name }}"
          --execute "source /tmp/create_db.sql"
  register: tablecreation
  changed_when: tablecreation.stderr is not search("45000.*table exists")
  become: Yes

- name: create foreign key relations for CoManage-Proxy linkup
  command: >
    mysql --batch --silent --raw --database "{{ comanage_proxy_db_name }}"
          --execute "source /tmp/fkeys.sql"
  register: keycreation
  changed_when: keycreation.stderr is not search("45000.*key exists")
  become: Yes

- name: create views for CoManage-Proxy linkup
  command: >
    mysql --batch --silent --raw --database "{{ comanage_proxy_db_name }}"
          --execute "source  /tmp/views.sql"
  register: viewcreation
  changed_when: viewcreation.stderr is not search("45000.*view exists")
  become: Yes

- name: Add additional ID columns
  command: >
    mysql --batch --silent --raw --database "{{ comanage_proxy_db_name }}"
          --execute "source  /tmp/copersoncol.sql"
  register: copersoncolcreation
  changed_when: copersoncolcreation.stderr is not search("45000.*column exists")
  become: Yes

- name: create user for mysql with all privilege
  mysql_user:
    name: "{{ comanage_proxy_db_user }}"
    host: "%"
    password: "{{ comanage_proxy_db_password }}"
    priv: "{{ comanage_proxy_db_name }}.*:ALL"
    state: present
  notify:
    - Restart MySQL
  become: Yes

# Create Attributes Hash database
- name: Copy hash_db file
  copy:
    src: "create_attributes_hash_db.sql"
    dest: /tmp/create_attributes_hash_db.sql

- name: create database for {{ satosa_db_name }}
  mysql_db:
    name: "{{ satosa_db_name }}"
    state: present

- name: create satosa attributes_hash table
  command: >
    mysql --batch --silent --raw --database "{{ satosa_db_name }}"
          --execute "source /tmp/create_attributes_hash_db.sql"
  register: tablecreation
  changed_when: tablecreation.stderr is not search("45000.*table exists")
  become: Yes

- name: create user for mysql with all privilege
  mysql_user:
    name: "{{ satosa_db_user }}"
    host: "%"
    password: "{{ satosa_db_password }}"
    priv: "{{ satosa_db_name }}.*:ALL"
    state: present
  notify:
    - Restart MySQL

- name: Install backup script
  template:
    src: "satosa_mysql_backup.sh.j2"
    dest: "{{backup_runparts}}/satosa_mysql_backup.sh"
    mode: 0755
