---
sudo: required

services:
  - docker

notifications:
  email:
    on_success: change
    on_failure: always
  slack:
    on_success: always
    on_failure: always
    secure: "bfADrrpWJfb7PNlLtrkAAScwORxjpDQ4lHM2VSfc6av4AWqz0IzCRZRWS+B9xKCaSDzLM2Tl+q8mJQ2BUjLwZ8Tp4FD2GZsUKHoylCHkfHcHweNOJgPfoOJbs/oTKrSbVqcKhBFyToEvN3r2ADyZHuSzTU/E19udc+MwUoB9fvcfUrCFOfCG8F2GC1iCBrkLiZ4YmpIR8Y+q3cZuO6Hk5yamZ4B6YD8YsgNgXJkgPw/C1g2nmOsKSETJr20XsiJkh2wDkm+0oDt/LvuvwBDnTzkqTaekweczaQyak16QKdAaUm4xvcZU7H2Jdgf6WQjyeh/Bkcn74CWw8hEmLlHIQYZxfc2WY+9JWDcXUd2nnRcTaMvb/B4hrPy+qlHDFWhyFg8S/F7D1TgEw5uI8k/talALcUFGP4CMbVTxlKEI5XdITmGMiO+hjnWxHQZnVo1F1O6m4goJPr52jaTzYpT3WaJW6AxjTaYPs0abrjjqYFshmcGItBYL5h6q4n+x4zQioRln3ITUQDVZnfg3qVXb+LDLFvZb+lxq8JCWkZ1CIVyFdesrmZVna88ubff1XOmYRNpU6xLdKgEONcHpXF6mMav6nl/2h7g46TlY5G9FegyU2pruBL78qKddTRiDqN+u19MwR4o+XsuNKk51wPSEeFCCwj7V9aR5cUAQ2yb9Vi8="

language: python
python:
  - 3.6

cache:
  pip: true
  directories:
    - "$HOME/docker"

git:
  submodules: false

addons:
  apt:
    packages:
      - bridge-utils
      - python3-jinja2
      - python3-yaml

before_install:
  - >
    if [ -d $HOME/docker ]; then
      ls $HOME/docker/*.tar.gz | xargs -I {file} sh -c "zcat {file} | docker load";
    fi
  - sudo pip install yamllint
  - sudo wget https://releases.hashicorp.com/vagrant/2.1.2/vagrant_2.1.2_x86_64.deb -P /tmp
  - sudo dpkg -i /tmp/vagrant_2.1.2_x86_64.deb
  - sudo apt-add-repository -y ppa:ansible/ansible-2.6
  - sudo apt -q update
  - sudo apt -y install ansible

script:
  - sudo ./scripts/travis_tests

before_cache:
  - mkdir -p $HOME/docker
  - "docker images -a --filter='dangling=false' --format '{{.Repository}}:{{.Tag}} {{.ID}}' \
        | xargs -n 2 -t sh -c 'test -e $HOME/docker/$1.tar.gz \
             || docker save $0 | gzip -c6 > $HOME/docker/$1.tar.gz' "
